{{ include parts_html_header.html }}

{{ if !n3s_is_login() }}
<div class="showblock" style="background-color:#fff0f0;">
  <span class="error">
    {{e: $backurl = urlencode('index.php?action=edit&page=new'); }}
    <a href="index.php?action=login&back={{$backurl}}">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ã„ã¾ã›ã‚“ã€‚
  </span>
</div>
{{ endif }}

<div class="showblock">
  <div class="memo" style="text-align:right;">
    [<a target="new" href="https://nadesi.com/v3/doc/index.php?%E6%96%87%E6%B3%95">
      ğŸ“Œæ–‡æ³•</a>]
    [<a target="new" href="https://nadesi.com/v3/doc/index.php?%E5%91%BD%E4%BB%A4%E4%B8%80%E8%A6%A7%2F%E6%A9%9F%E8%83%BD%E9%A0%86">
      ğŸ¨å‘½ä»¤ä¸€è¦§</a>]
  </div>
  <div>
    <h1>
      [ç·¨é›†ãƒ¢ãƒ¼ãƒ‰]
      {{ $title | check_mudai }}
      {{if $is_private}}ğŸ”’{{endif}}
    </h1>
    <p class="memo">{{ $memo }}</p>
  </div>
  <div id="edit-layout-header">
    <label>ãƒ—ãƒ­ã‚°ãƒ©ãƒ :
      <span id="sizeSwitch">(â†’å¤§)</span>
      <span id="editSwitch">(â†’textarea)</span>
      <span id="editLayoutButton">(â†’å·¦å³ã«é…ç½®)</span>
    </label>
  </div>
  <!-- ä¸Šä¸‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ-->
  <div id="edit-layout-ud" class="">
    <div id="edit-layout-u">
      <textarea id="nako3code">{{ $body }}</textarea>
    </div>
    <div id="edit-layout-u2">
      <div id="controll_buttons">
        <span style="float:left;">
          <button id="runButton" class="pure-button pure-button-primary">â–¶ å®Ÿ è¡Œ [F9]</button>
          <button id="clearButton" class="pure-button">ã‚¯ãƒªã‚¢</button>
          <button id="tempSaveButton" class="pure-button" onclick="tmepSaveClick()">ä¸€æ™‚ä¿å­˜</button>
          <label for="debugCheck" style="border: 1px silver dotted; padding: 6px;"><input id="debugCheck" type="checkbox" class="pure-checkbox">ãƒ‡ãƒãƒƒã‚°</label>
          <span id="breakpointButtons" style="display:none">
            <span style="font-size:0.5em;">ãƒ–ãƒ¬ã‚¤ã‚¯ãƒã‚¤ãƒ³ãƒˆ: </span>
            <button id="breakpointPlay" class="pure-button" onclick="breakpointPlay()">â†’ å†é–‹</button>
            <button id="breakpointNext" class="pure-button" onclick="breakpointNext()">â†“ ä¸€è¡Œæ¬¡ã¸</button>
          </span>
          <span id="tempInfoLabel"></span>
        </span>
        <span class="memo" style="white-space: nowrap; padding-top: 8px; float:right;">
            ã‚­ãƒ£ãƒ³ãƒã‚¹:
            å¹… <input type="text" id="canvas_w" value="{{$canvas_w}}" size="3">Ã—
            é«˜ <input type="text" id="canvas_h" value="{{$canvas_h}}" size="3">
        </span>
        <div style="clear:both;"></div>
      </div><!-- /#controll_buttons -->
    </div>
    <div id="edit-layout-d">
      <div id="runbox">
        <!-- 3.1.19ä»¥ä¸Š -->
        <div id="nako3_output" style="display:none"></div>
        <!-- 3.1.18ä»¥ä¸‹ -->
        <div id="nako3_error" style="display:none"></div> 
        <!-- info box -->
        <div class="nako3row nako3info" id="nako3_info" style="display:none"></div>
    
        <canvas id='nako3_canvas' width='{{$canvas_w}}' height='{{$canvas_h}}'></canvas>
        <div id='nako3_div' class='nako3_div'></div>
      </div>
    </div>
  </div>
  <!-- /ä¸Šä¸‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ-->

  <!-- å·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div id="edit-layout-lr" class="pure-g">
    <div id="edit-layout-l" class="pure-u-1-2"></div>
    <div id="edit-layout-r" class="pure-u-1-2"></div>
  </div>
  <!-- /å·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
</div>

<!-- ç·¨é›†ãƒœã‚¿ãƒ³ -->
<div class="ctrl_block">
  {{if $app_id == 0}}
    <p><button onclick="saveClick(true)" class="pure-button">æ–°è¦ä¿å­˜</button></p>
  {{else}}
    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    {{if n3s_is_login()}}
      {{if ($my_user_id === $user_id) || n3s_is_admin()}}
      <p><button onclick="saveClick(false)" class="pure-button">ä¸Šæ›¸ãä¿å­˜</button></p>
      {{endif}}
    {{else}}
      <p><button onclick="saveClick(false)" class="pure-button">ä¸Šæ›¸ãä¿å­˜</button></p>
    {{endif}}
    <p><a href="index.php?action=show&page={{$app_id}}" class="pure-button">è¡¨ç¤ºãƒšãƒ¼ã‚¸</a></p>
  {{endif}}
  
  <!-- å¾©å…ƒãƒœã‚¿ãƒ³ -->
  <p style="text-align:right;font-size:0.7em;">
    <a name="recover_btn" href="#" id="recover_btn">
    â†’ç›´å‰ã«å®Ÿè¡Œ(ã¾ãŸã¯ä¸€æ™‚ä¿å­˜)ã—ãŸå†…å®¹ã‚’å¾©å…ƒ<span id="tempSaveLabel"></span></a></p>
  <!-- ãªã§ã—ã“ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ãƒœã‚¿ãƒ³ -->
  <p style="text-align:right;font-size:0.7em;">ãªã§ã—ã“ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v
    <input id="forceNakoVer" type="text" value="{{$version}}" onchange="changeNakoVersion()"/>
    <input type="button" value="å¤‰æ›´" onclick="changeNakoVersion()">
    <input type="button" value="æœ€æ–°" onclick="changeNakoNewVersion()">
  </p>
</div>

<div class="ctrl_block">
  <h1>ç´ æã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
  {{ if n3s_is_login() }}
  <p><a target="new" href="index.php?action=upload" class="pure-button">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’é–‹ã</a></p>
  {{ else }}
  <p><a href="index.php?action=login">ãƒ­ã‚°ã‚¤ãƒ³</a>ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
  {{ endif }}
</div>

<!-- save form -->
<div style="display: none;">
  <form id="n3s_save_form" method="post" action="index.php?action=save&amp;page={{$app_id}}&amp;load_src=no">
    <input id="save_form_canvas_w" type="hidden" name="canvas_w" value="">
    <input id="save_form_canvas_h" type="hidden" name="canvas_h" value="">
    <input id="save_form_version" type="hidden" name="version" value="">
    <input id="save_form_action_time" type="hidden" name="action_time" value="">
    <input type="hidden" name="editkey" value="{{ $editkey }}">
    <textarea id="save_form_body" name="body"></textarea>
  </form>
</div>

<!-- script for ace editor -->
{{ $import_editor | raw }}
<!-- script for nadesiko3 -->
{{ if $custom_head eq '' }}
{{   $import_nako | raw }}
{{ else }}
{{   $custom_head | raw }}
{{ endif }}

<!-- script for nako3storage-->
<script>
// nako3storage_show.js ã‹ã‚‰å‚ç…§ã™ã‚‹å¤‰æ•°
var setValue = function() { alert("ç¾åœ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚") }
var getValue = function() { alert("ç¾åœ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚"); return "" }
var editorObjects = null
var msie = {{e:echo ($msie)?'true':'false'}};

// nako3storage info
const baseurl = '{{ $baseurl | safe }}';
const editlink = 'index.php?action=save&page={{$app_id}}&mode=load&from=localStorage';

// nako3 program info
const app_id = {{ $app_id }};
const nako_version = '{{ $version }}' + '.0.0.0' // å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è€ƒæ…®
const newNakoVersion = '{{ $newNakoVersion }}'
const runbox_c = document.getElementById('runbox')
runbox_c.style.display = 'none'

// ç§»å‹•å‰ã®ç¢ºèª
let askBeforeUnload = true
window.addEventListener('beforeunload', function(event) {
  if (askBeforeUnload) {
    event.preventDefault();
    event.returnValue = '';
  }
});

// ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡
window.addEventListener('message', (e) => {
  if (!e.data || !e.data.action) { return }
  if (e.data.action !== 'nako3storage.debug.line') { return }
  const line = e.data.line
  if (typeof line !== 'string') { return }
  if (!navigator.__aceEditor) { return }
  const chk = document.getElementById('debugCheck')
  if (!chk || !chk.checked) { return }
  const m = line.match(/l(\+?\d+):/)
  if (!m) { return }
  const lineNo = parseInt(m[1])
  if (lineNo >= 1) {
    navigator.__aceEditor.gotoLine(lineNo)
  }
})

</script>
<script defer src="{{e:echo n3s_getURL('nako3storage_edit.js', 'file', ['m'=>$mtime_nako3storage_edit]);}}"></script>
<script defer src="{{e:echo n3s_getURL('nako3storage_show.js', 'file', ['m'=>$mtime_nako3storage_show]);}}"></script>

{{ include parts_html_footer.html }}
